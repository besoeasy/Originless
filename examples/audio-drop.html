<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Originless Audio Drop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100">
  <div id="app" class="max-w-5xl mx-auto px-6 py-10">
    <header class="mb-10">
      <p class="text-sm uppercase tracking-[0.3em] text-slate-400">Originless</p>
      <h1 class="text-4xl font-bold mt-3">Audio Drop</h1>
      <p class="text-slate-300 mt-3 max-w-2xl">
        Record a short audio clip in your browser, upload it to Originless, and share the link.
      </p>
      <div class="mt-6 bg-slate-900/70 border border-slate-800 rounded-xl p-4">
        <p class="text-xs text-slate-400">Originless Server</p>
        <p class="text-sm font-mono break-all">{{ originlessServer }}</p>
      </div>
    </header>

    <div class="grid gap-8 lg:grid-cols-2">
      <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-6 shadow-xl">
        <h2 class="text-2xl font-semibold mb-4">Record</h2>
        <p class="text-sm text-slate-400 mb-4">Use your microphone to capture a quick voice note.</p>

        <div class="flex flex-wrap gap-3">
          <button @click="startRecording" :disabled="recording || busy"
            class="px-5 py-3 rounded-xl bg-emerald-400 text-slate-900 font-semibold hover:bg-emerald-300 disabled:opacity-50 disabled:cursor-not-allowed transition">
            Start Recording
          </button>
          <button @click="stopRecording" :disabled="!recording"
            class="px-5 py-3 rounded-xl bg-amber-300 text-slate-900 font-semibold hover:bg-amber-200 disabled:opacity-50 disabled:cursor-not-allowed transition">
            Stop
          </button>
          <button @click="resetAll" class="px-5 py-3 rounded-xl text-slate-400 hover:text-slate-100 transition">
            Reset
          </button>
        </div>

        <div class="mt-4 text-sm text-slate-400">
          <span v-if="recording">Recording... {{ elapsed }}s</span>
          <span v-else>Ready to record.</span>
        </div>

        <div v-if="audioUrl" class="mt-6">
          <p class="text-xs text-slate-400 mb-2">Preview</p>
          <audio :src="audioUrl" controls class="w-full"></audio>
        </div>

        <div class="mt-6">
          <button @click="uploadAudio" :disabled="busy || !audioBlob"
            class="px-5 py-3 rounded-xl bg-sky-400 text-slate-900 font-semibold hover:bg-sky-300 disabled:opacity-50 disabled:cursor-not-allowed transition">
            {{ busy ? 'Uploading...' : 'Upload Audio' }}
          </button>
        </div>

        <div v-if="result" class="mt-6 space-y-4">
          <div class="bg-emerald-950/40 border border-emerald-700 rounded-xl p-4">
            <p class="text-xs text-emerald-200">Uploaded CID</p>
            <p class="font-mono text-sm break-all mt-1">{{ result.cid }}</p>
            <p class="text-xs text-emerald-200 mt-2">Gateway URL</p>
            <a :href="result.url" target="_blank"
              class="text-xs text-emerald-300 break-all hover:underline">{{ result.url }}</a>
          </div>

          <div class="bg-slate-950 border border-slate-800 rounded-xl p-4">
            <p class="text-xs text-slate-400">Share link</p>
            <div class="flex gap-2 mt-2">
              <input type="text" readonly :value="shareLink"
                class="flex-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-xs font-mono text-slate-200" />
              <button @click="copyShareLink"
                class="px-4 py-2 rounded-lg bg-slate-200 text-slate-900 font-semibold hover:bg-white transition">Copy</button>
            </div>
          </div>
        </div>

        <div v-if="error" class="mt-6 text-sm text-red-300 bg-red-900/30 border border-red-800 rounded-xl p-3">
          {{ error }}
        </div>
      </section>

      <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-6 shadow-xl">
        <h2 class="text-2xl font-semibold mb-4">Listen</h2>
        <p class="text-sm text-slate-400 mb-4">Paste a share link or CID to listen.</p>

        <label class="block text-sm text-slate-300 mb-2">Audio URL or CID</label>
        <input v-model.trim="viewSource" type="text"
          class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-500"
          placeholder="https://.../ipfs/<cid> or CID" />

        <div class="mt-5 flex flex-wrap gap-3">
          <button @click="loadAudio" :disabled="!viewSource"
            class="px-5 py-3 rounded-xl bg-sky-400 text-slate-900 font-semibold hover:bg-sky-300 disabled:opacity-50 disabled:cursor-not-allowed transition">
            Load Audio
          </button>
          <button @click="pasteFromHash" class="px-5 py-3 rounded-xl border border-slate-700 text-slate-200 font-semibold hover:border-slate-400 transition">
            Load from link hash
          </button>
        </div>

        <div v-if="viewUrl" class="mt-6">
          <p class="text-xs text-slate-400 mb-2">Audio playback</p>
          <audio :src="viewUrl" controls class="w-full"></audio>
          <p class="text-xs text-slate-500 mt-2 break-all">{{ viewUrl }}</p>
        </div>
      </section>
    </div>

    <footer class="mt-12 text-xs text-slate-500">
      Audio is uploaded unpinned; availability depends on IPFS propagation and your node's retention policy.
    </footer>
  </div>

  <script>
    const Originless_Server = "https://filedrop.besoeasy.com";
    const gatewayBase = "https://dweb.link/ipfs/";

    const { createApp } = Vue;

    createApp({
      data() {
        return {
          originlessServer: Originless_Server,
          recording: false,
          recorder: null,
          chunks: [],
          audioBlob: null,
          audioUrl: "",
          elapsed: 0,
          timer: null,
          busy: false,
          result: null,
          shareLink: "",
          viewSource: "",
          viewUrl: "",
          error: "",
        };
      },
      mounted() {
        this.pasteFromHash();
      },
      methods: {
        resetAll() {
          this.recording = false;
          this.chunks = [];
          this.audioBlob = null;
          this.audioUrl = "";
          this.elapsed = 0;
          this.result = null;
          this.shareLink = "";
          this.viewSource = "";
          this.viewUrl = "";
          this.error = "";
          if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
          }
        },
        async startRecording() {
          this.error = "";
          if (!navigator.mediaDevices?.getUserMedia) {
            this.error = "Microphone access is not supported in this browser.";
            return;
          }

          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.recorder = new MediaRecorder(stream);
            this.chunks = [];
            this.recorder.ondataavailable = (event) => {
              if (event.data.size > 0) {
                this.chunks.push(event.data);
              }
            };
            this.recorder.onstop = () => {
              this.audioBlob = new Blob(this.chunks, { type: this.recorder.mimeType || "audio/webm" });
              this.audioUrl = URL.createObjectURL(this.audioBlob);
              stream.getTracks().forEach((track) => track.stop());
            };
            this.recorder.start();
            this.recording = true;
            this.elapsed = 0;
            this.timer = setInterval(() => {
              this.elapsed += 1;
            }, 1000);
          } catch (err) {
            this.error = err.message || "Failed to access microphone";
          }
        },
        stopRecording() {
          if (!this.recording || !this.recorder) return;
          this.recording = false;
          this.recorder.stop();
          if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
          }
        },
        async uploadAudio() {
          this.error = "";
          this.result = null;
          this.shareLink = "";

          try {
            this.busy = true;
            const formData = new FormData();
            formData.append("file", this.audioBlob, "voice-note.webm");

            const response = await fetch(`${Originless_Server}/upload`, {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              const text = await response.text();
              throw new Error(text || `Upload failed (${response.status})`);
            }

            const data = await response.json();
            this.result = { cid: data.cid, url: data.url };
            this.shareLink = this.buildShareLink(data.url);
            this.viewSource = data.url;
            this.viewUrl = data.url;
          } catch (err) {
            this.error = err.message || "Failed to upload audio";
          } finally {
            this.busy = false;
          }
        },
        buildShareLink(url) {
          const params = new URLSearchParams();
          if (url) {
            params.set("u", url);
          }
          return `${location.origin}${location.pathname}#${params.toString()}`;
        },
        pasteFromHash() {
          if (!location.hash) return;
          const params = new URLSearchParams(location.hash.slice(1));
          const url = params.get("u");
          if (url) {
            this.viewSource = url;
            this.viewUrl = url;
          }
        },
        loadAudio() {
          const source = this.viewSource.trim();
          if (!source) return;

          if (/^https?:\/\//i.test(source)) {
            this.viewUrl = source;
            return;
          }

          if (/^[a-z0-9]{46,}$/i.test(source)) {
            this.viewUrl = `${gatewayBase}${source}`;
            return;
          }

          this.error = "Unrecognized URL or CID";
        },
        async copyShareLink() {
          if (!this.shareLink) return;
          await navigator.clipboard.writeText(this.shareLink);
        },
      },
    }).mount("#app");
  </script>
</body>

</html>
