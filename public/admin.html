<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FileDrop Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* Import modern font */
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

    body {
      font-family: "Inter", sans-serif;
    }

    /* Enhanced animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    /* Enhanced glassmorphism */
    .glassmorphism {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* Enhanced hover effects */
    .hover-lift {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Status pulse animation */
    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    .status-indicator {
      position: relative;
    }

    .status-indicator::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-100">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-black p-6 text-white">
      <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i class="fas fa-chart-line text-2xl"></i>
            <div>
              <h1 class="text-3xl font-bold">Admin Dashboard</h1>
              <p class="text-gray-300 text-sm">Nostr pinning and media overview</p>
            </div>
          </div>
          <div class="flex gap-3">
            <button id="refresh"
              class="px-4 py-2 rounded-lg bg-white text-black font-semibold hover:bg-gray-200 transition-colors">
              <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
            <a href="/"
              class="px-4 py-2 rounded-lg border border-white text-white hover:bg-white hover:text-black transition-colors">
              <i class="fas fa-home mr-2"></i>Back to App
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <div class="max-w-6xl mx-auto">
        <!-- Alert Box -->
        <div id="alert" class="hidden mb-6 bg-white rounded-xl border border-red-500 p-4 shadow-lg animate-fade-in">
          <div class="flex items-center gap-3">
            <i class="fas fa-exclamation-circle text-red-600 text-2xl"></i>
            <div id="alertContent"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Left Column - Main Info -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Operator Card -->
            <div id="operatorCard" class="glassmorphism rounded-2xl shadow-xl p-6 hover-lift animate-fade-in">
              <div class="flex items-center gap-3 mb-4">
                <div class="status-indicator">
                  <i class="fas fa-user-shield text-2xl text-black"></i>
                </div>
                <div class="flex-1">
                  <p class="text-xs uppercase tracking-wider text-gray-500 font-medium">Operator</p>
                  <a id="operatorLink" href="#" target="_blank"
                    class="text-lg font-semibold text-black hover:underline break-all"></a>
                </div>
              </div>
              <div class="space-y-2 text-sm">
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <p class="text-gray-500 font-medium text-xs uppercase">Relays</p>
                  <p class="text-black font-mono text-sm" id="relays">-</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <p class="text-gray-500 font-medium text-xs uppercase">Last Run</p>
                  <p class="text-black text-sm" id="lastRun">-</p>
                </div>
              </div>
            </div>

            <!-- Friends Card -->
            <div id="friendsCard" class="glassmorphism rounded-2xl shadow-xl p-6 hover-lift animate-fade-in">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                  <i class="fas fa-users text-2xl text-black"></i>
                  <div>
                    <h2 class="text-lg font-semibold text-black">Friends</h2>
                  </div>
                </div>
                <span id="friendsStatus"
                  class="px-3 py-1 text-xs rounded-full bg-gray-200 text-black font-medium"></span>
              </div>
              <div id="noFriends" class="text-gray-500 text-sm hidden">No follows detected.</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-96 overflow-y-auto" id="friendsList"></div>
            </div>
          </div>

          <!-- Right Column - Stats -->
          <div class="space-y-6">
            <!-- Pin Stats Card -->
            <div id="pinCard" class="glassmorphism rounded-2xl shadow-xl p-6 hover-lift animate-fade-in">
              <div class="flex items-center gap-3 mb-4">
                <i class="fas fa-thumbtack text-2xl text-black"></i>
                <div class="flex-1">
                  <p class="text-xs uppercase tracking-wider text-gray-500 font-medium">Pinned Files</p>
                  <p class="text-3xl font-bold text-black" id="pinsTotal">0</p>
                </div>
              </div>
              <div class="space-y-3">
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm font-medium">Self</span>
                    <span class="text-black font-bold" id="pinsSelf">0</span>
                  </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm font-medium">Friends</span>
                    <span class="text-black font-bold" id="pinsFriends">0</span>
                  </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <p class="text-gray-500 font-medium text-xs uppercase mb-1">Pinned Content Size</p>
                  <p class="text-black font-bold text-lg" id="pinnedSize">-</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <p class="text-gray-500 font-medium text-xs uppercase mb-1">Repository Size</p>
                  <p class="text-black font-bold text-lg" id="repoSize">-</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pins History Table -->
        <div class="mt-6">
          <div class="glassmorphism rounded-2xl shadow-xl p-6 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-3">
                <i class="fas fa-history text-2xl text-black"></i>
                <div>
                  <h2 class="text-2xl font-bold text-black">Pinned Content History</h2>
                  <p class="text-gray-500 text-sm">Track all media pinned from Nostr events</p>
                </div>
              </div>
              <div class="flex gap-2">
                <select id="filterType" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                  <option value="">All Types</option>
                  <option value="self">Self Only</option>
                  <option value="friend">Friends Only</option>
                </select>
                <button id="refreshPins"
                  class="px-4 py-2 rounded-lg bg-black text-white hover:bg-gray-800 transition-colors">
                  <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
              </div>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-blue-600 text-xs font-semibold uppercase mb-1">Total Pins</p>
                <p class="text-blue-900 text-2xl font-bold" id="statsTotal">0</p>
              </div>
              <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <p class="text-green-600 text-xs font-semibold uppercase mb-1">Self Pinned</p>
                <p class="text-green-900 text-2xl font-bold" id="statsSelfPinned">0</p>
              </div>
              <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                <p class="text-purple-600 text-xs font-semibold uppercase mb-1">Friends Cached</p>
                <p class="text-purple-900 text-2xl font-bold" id="statsFriendsCached">0</p>
              </div>
              <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                <p class="text-orange-600 text-xs font-semibold uppercase mb-1">Total Size</p>
                <p class="text-orange-900 text-xl font-bold" id="statsSize">0 B</p>
              </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-100 border-b-2 border-gray-300">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Event ID</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">CID</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Size</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Timestamp</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Author</th>
                  </tr>
                </thead>
                <tbody id="pinsTableBody" class="divide-y divide-gray-200">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                      <i class="fas fa-spinner fa-spin mr-2"></i>Loading pins...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
              <div class="text-sm text-gray-600" id="paginationInfo">Showing 0 of 0</div>
              <div class="flex gap-2">
                <button id="prevPage"
                  class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
                  <i class="fas fa-chevron-left mr-2"></i>Previous
                </button>
                <button id="nextPage"
                  class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
                  Next<i class="fas fa-chevron-right ml-2"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-black p-4 text-center">
      <div class="flex items-center justify-center gap-4">
        <a href="https://github.com/besoeasy/file-drop" target="_blank"
          class="flex items-center gap-2 text-white hover:text-gray-300 transition-colors duration-300">
          <i class="fab fa-github"></i>
          <span class="font-semibold">GitHub</span>
        </a>
        <span class="text-gray-400">•</span>
        <span class="text-gray-300 font-mono text-sm">Admin Panel</span>
      </div>
    </footer>
  </div>

  <script>
    const operatorLink = document.getElementById("operatorLink");
    const relaysEl = document.getElementById("relays");
    const lastRunEl = document.getElementById("lastRun");
    const friendsStatus = document.getElementById("friendsStatus");
    const friendsList = document.getElementById("friendsList");
    const noFriends = document.getElementById("noFriends");
    const alertBox = document.getElementById("alert");
    const alertContent = document.getElementById("alertContent");
    const friendsCard = document.getElementById("friendsCard");
    const operatorCard = document.getElementById("operatorCard");

    async function load() {
      alertBox.classList.add("hidden");
      try {
        const res = await fetch("/nostr");
        const data = await res.json();

        if (!data.enabled) {
          alertBox.classList.remove("hidden");
          alertContent.innerHTML = `<div><div class="font-semibold text-red-800">Nostr Disabled</div><div class="text-red-600 text-sm mt-1">${data.reason || "NPUB not set"}</div></div>`;
          operatorCard.classList.add("hidden");
          friendsCard.classList.add("hidden");
          return;
        }

        operatorCard.classList.remove("hidden");
        friendsCard.classList.remove("hidden");

        const op = data.operator || "Unknown";
        operatorLink.textContent = op;
        operatorLink.href = `https://nosta.me/${encodeURIComponent(op)}`;
        relaysEl.textContent = (data.relays || []).join(" · ") || "-";
        lastRunEl.textContent = data.lastRun?.at || "-";

        // Friends caching is always enabled
        friendsStatus.textContent = "Caching Enabled";
        friendsStatus.className = "px-3 py-1 text-xs rounded-full bg-black text-white font-medium";
        const friends = data.friends || [];
        friendsList.innerHTML = "";
        friends.forEach((f) => {
          const card = document.createElement("div");
          card.className = "border border-gray-200 bg-white rounded-lg px-3 py-2 text-sm hover:border-black hover:shadow-md transition-all";
          card.innerHTML = `<a class="text-black hover:underline font-medium break-all" href="https://nosta.me/${encodeURIComponent(f)}" target="_blank">${f}</a>`;
          friendsList.appendChild(card);
        });
        noFriends.classList.toggle("hidden", friends.length !== 0);

        // Update pin stats from the same response
        document.getElementById("pinsTotal").textContent = data.pins?.total ?? 0;
        document.getElementById("pinsSelf").textContent = data.pins?.self ?? 0;
        document.getElementById("pinsFriends").textContent = data.pins?.friends ?? 0;
        const size = data.repo?.size || 0;
        document.getElementById("repoSize").textContent = formatBytes(size);
        const pinnedSize = data.pins?.totalSize || 0;
        document.getElementById("pinnedSize").textContent = formatBytes(pinnedSize);
      } catch (err) {
        alertBox.classList.remove("hidden");
        alertContent.innerHTML = `<div><div class="font-semibold text-red-800">Error</div><div class="text-red-600 text-sm mt-1">${err.message}</div></div>`;
        // Reset pin stats on error
        document.getElementById("pinsTotal").textContent = "-";
        document.getElementById("pinsSelf").textContent = "-";
        document.getElementById("pinsFriends").textContent = "-";
        document.getElementById("repoSize").textContent = "Error";
        document.getElementById("pinnedSize").textContent = "Error";
      }
    }

    function formatBytes(bytes) {
      const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
      if (!bytes) return "0 Bytes";
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(2) + " " + sizes[i];
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp * 1000);
      return date.toLocaleString();
    }

    function truncate(str, len = 12) {
      if (!str) return '-';
      if (str.length <= len) return str;
      return str.substring(0, len) + '...';
    }

    // Pins table management
    let currentPage = 0;
    const limit = 50;

    async function loadPins() {
      const filterType = document.getElementById("filterType").value;
      const pinsTableBody = document.getElementById("pinsTableBody");

      try {
        pinsTableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';

        let url = `/api/pins?limit=${limit}&offset=${currentPage * limit}`;
        if (filterType) {
          url += `&type=${filterType}`;
        }

        const res = await fetch(url);
        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load pins');
        }

        // Update stats
        const stats = data.stats || {};
        const selfPinned = (stats.self_pinned?.count || 0) + (stats.self_pending?.count || 0);
        const friendsCached = (stats.friend_cached?.count || 0) + (stats.friend_pending?.count || 0);
        const totalSize = Object.values(stats).reduce((sum, stat) => sum + (stat.totalSize || 0), 0);

        document.getElementById("statsTotal").textContent = data.pagination.total;
        document.getElementById("statsSelfPinned").textContent = selfPinned;
        document.getElementById("statsFriendsCached").textContent = friendsCached;
        document.getElementById("statsSize").textContent = formatBytes(totalSize);

        // Update table
        const pins = data.pins || [];
        if (pins.length === 0) {
          pinsTableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No pins found</td></tr>';
        } else {
          pinsTableBody.innerHTML = pins.map(pin => {
            const statusColor = {
              'pinned': 'bg-green-100 text-green-800',
              'cached': 'bg-blue-100 text-blue-800',
              'pending': 'bg-yellow-100 text-yellow-800',
              'failed': 'bg-red-100 text-red-800'
            }[pin.status] || 'bg-gray-100 text-gray-800';

            const typeColor = pin.type === 'self' ? 'bg-purple-100 text-purple-800' : 'bg-indigo-100 text-indigo-800';
            
            return `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3">
                  <a href="https://primal.net/e/${pin.eventId}" target="_blank" 
                     class="text-blue-600 hover:underline font-mono text-xs"
                     title="${pin.eventId}">
                    ${truncate(pin.eventId, 16)}
                  </a>
                </td>
                <td class="px-4 py-3">
                  <a href="https://ipfs.io/ipfs/${pin.cid}" target="_blank" 
                     class="text-blue-600 hover:underline font-mono text-xs"
                     title="${pin.cid}">
                    ${truncate(pin.cid, 16)}
                  </a>
                </td>
                <td class="px-4 py-3 font-mono text-xs">${formatBytes(pin.size)}</td>
                <td class="px-4 py-3">
                  <span class="px-2 py-1 rounded-full text-xs font-semibold ${typeColor}">
                    ${pin.type}
                  </span>
                </td>
                <td class="px-4 py-3">
                  <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                    ${pin.status}
                  </span>
                </td>
                <td class="px-4 py-3 text-xs text-gray-600">${formatTimestamp(pin.timestamp)}</td>
                <td class="px-4 py-3">
                  <a href="https://nosta.me/${pin.author}" target="_blank" 
                     class="text-blue-600 hover:underline font-mono text-xs"
                     title="${pin.author}">
                    ${truncate(pin.author, 12)}
                  </a>
                </td>
              </tr>
            `;
          }).join('');
        }

        // Update pagination
        const start = currentPage * limit + 1;
        const end = Math.min((currentPage + 1) * limit, data.pagination.total);
        document.getElementById("paginationInfo").textContent = 
          `Showing ${start}-${end} of ${data.pagination.total}`;

        document.getElementById("prevPage").disabled = currentPage === 0;
        document.getElementById("nextPage").disabled = !data.pagination.hasMore;

      } catch (err) {
        console.error('Failed to load pins:', err);
        pinsTableBody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Error: ${err.message}</td></tr>`;
      }
    }

    document.getElementById("refresh").addEventListener("click", () => {
      load();
    });

    document.getElementById("refreshPins").addEventListener("click", () => {
      currentPage = 0;
      loadPins();
    });

    document.getElementById("filterType").addEventListener("change", () => {
      currentPage = 0;
      loadPins();
    });

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 0) {
        currentPage--;
        loadPins();
      }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      currentPage++;
      loadPins();
    });

    load();
    loadPins();
  </script>
</body>

</html>