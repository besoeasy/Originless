<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FileDrop Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: radial-gradient(circle at 20% 20%, rgba(123,196,255,0.08), transparent 25%), radial-gradient(circle at 80% 10%, rgba(147,51,234,0.08), transparent 22%), #0b0e14; }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
      <div>
        <p class="text-sm text-slate-400">FileDrop</p>
        <h1 class="text-3xl font-bold tracking-tight">Admin Dashboard</h1>
        <p class="text-slate-400 mt-1">Nostr pinning and pinned media overview</p>
      </div>
      <div class="flex gap-3">
        <button id="refresh" class="px-4 py-2 rounded-lg bg-sky-500 text-slate-900 font-semibold shadow hover:bg-sky-400">Refresh</button>
        <a href="/" class="px-4 py-2 rounded-lg border border-slate-700 text-slate-200 hover:border-slate-500">Back to app</a>
      </div>
    </div>

    <div id="alert" class="hidden mb-6 rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm"></div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 space-y-6">
        <div class="rounded-2xl border border-slate-800 bg-[#111522] shadow-xl p-6" id="operatorCard">
          <div class="flex items-center gap-3 mb-2">
            <div class="h-10 w-10 rounded-xl bg-sky-500/15 text-sky-200 flex items-center justify-center font-semibold">OP</div>
            <div>
              <p class="text-xs uppercase tracking-[0.18em] text-slate-500">Operator</p>
              <a id="operatorLink" href="#" target="_blank" class="text-lg font-semibold text-slate-100 hover:text-sky-300 break-all"></a>
            </div>
          </div>
          <p class="text-slate-400 text-sm">Relays: <span id="relays">-</span></p>
          <p class="text-slate-500 text-sm mt-2">Last run: <span id="lastRun">-</span></p>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-[#111522] shadow-xl p-6" id="friendsCard">
          <div class="flex items-center gap-3 mb-3">
            <div class="h-10 w-10 rounded-xl bg-purple-500/15 text-purple-200 flex items-center justify-center font-semibold">FR</div>
            <div class="flex items-center gap-2">
              <h2 class="text-lg font-semibold text-slate-100">Friends</h2>
              <span id="friendsStatus" class="px-2.5 py-1 text-xs rounded-full bg-slate-800 text-slate-300"></span>
            </div>
          </div>
          <div id="noFriends" class="text-slate-500 text-sm hidden">No follows detected.</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2" id="friendsList"></div>
        </div>
      </div>

      <div class="space-y-6">
        <div class="rounded-2xl border border-slate-800 bg-[#111522] shadow-xl p-6" id="pinCard">
          <div class="flex items-center gap-3 mb-2">
            <div class="h-10 w-10 rounded-xl bg-emerald-500/15 text-emerald-200 flex items-center justify-center font-semibold">PN</div>
            <div>
              <p class="text-xs uppercase tracking-[0.18em] text-slate-500">Pinned Files</p>
              <p class="text-xl font-semibold text-slate-100" id="pinsTotal">0</p>
            </div>
          </div>
          <p class="text-slate-400 text-sm">Self: <span id="pinsSelf">0</span> · Friends: <span id="pinsFriends">0</span></p>
          <p class="text-slate-500 text-sm mt-2">Pinned size (repo): <span id="repoSize">-</span></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const operatorLink = document.getElementById("operatorLink");
    const relaysEl = document.getElementById("relays");
    const lastRunEl = document.getElementById("lastRun");
    const friendsStatus = document.getElementById("friendsStatus");
    const friendsList = document.getElementById("friendsList");
    const noFriends = document.getElementById("noFriends");
    const alertBox = document.getElementById("alert");
    const friendsCard = document.getElementById("friendsCard");
    const operatorCard = document.getElementById("operatorCard");

    async function load() {
      alertBox.classList.add("hidden");
      try {
        const res = await fetch("/nostr");
        const data = await res.json();

        if (!data.enabled) {
          alertBox.classList.remove("hidden");
          alertBox.innerHTML = `<div class="font-semibold">Nostr disabled</div><div class="text-slate-300 text-sm mt-1">${data.reason || "NPUB not set"}</div>`;
          operatorCard.classList.add("hidden");
          friendsCard.classList.add("hidden");
          return;
        }

        operatorCard.classList.remove("hidden");
        friendsCard.classList.remove("hidden");

        const op = data.operator || "Unknown";
        operatorLink.textContent = op;
        operatorLink.href = `https://nosta.me/${encodeURIComponent(op)}`;
        relaysEl.textContent = (data.relays || []).join(" · ") || "-";
        lastRunEl.textContent = data.lastRun?.at || "-";

        if (data.pinFriends) {
          friendsStatus.textContent = "Pinning enabled";
          friendsStatus.className = "px-2.5 py-1 text-xs rounded-full bg-emerald-500/20 text-emerald-100";
          const friends = data.friends || [];
          friendsList.innerHTML = "";
          friends.forEach((f) => {
            const card = document.createElement("div");
            card.className = "border border-slate-800 bg-slate-900/60 rounded-xl px-3 py-2 text-sm";
            card.innerHTML = `<a class="text-sky-300 hover:text-sky-200 break-all" href="https://nosta.me/${encodeURIComponent(f)}" target="_blank">${f}</a>`;
            friendsList.appendChild(card);
          });
          noFriends.classList.toggle("hidden", friends.length !== 0);
        } else {
          friendsStatus.textContent = "Pinning disabled";
          friendsStatus.className = "px-2.5 py-1 text-xs rounded-full bg-slate-800 text-slate-300";
          friendsList.innerHTML = "";
          noFriends.classList.remove("hidden");
        }
      } catch (err) {
        alertBox.classList.remove("hidden");
        alertBox.innerHTML = `<div class="font-semibold">Error</div><div class="text-slate-300 text-sm mt-1">${err.message}</div>`;
      }
    }

    async function loadPinStats() {
      try {
        const res = await fetch("/pin-stats");
        const data = await res.json();
        if (data.status !== "success") throw new Error(data.error || "Failed to load pin stats");
        document.getElementById("pinsTotal").textContent = data.pins?.total ?? 0;
        document.getElementById("pinsSelf").textContent = data.pins?.self ?? 0;
        document.getElementById("pinsFriends").textContent = data.pins?.friends ?? 0;
        const size = data.repo?.size || 0;
        document.getElementById("repoSize").textContent = formatBytes(size);
      } catch (err) {
        document.getElementById("pinsTotal").textContent = "-";
        document.getElementById("pinsSelf").textContent = "-";
        document.getElementById("pinsFriends").textContent = "-";
        document.getElementById("repoSize").textContent = "Error";
      }
    }

    function formatBytes(bytes) {
      const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
      if (!bytes) return "0 Bytes";
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(2) + " " + sizes[i];
    }

    document.getElementById("refresh").addEventListener("click", () => {
      load();
      loadPinStats();
    });

    load();
    loadPinStats();
  </script>
</body>
</html>
