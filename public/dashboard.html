<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Originless Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* Import modern font */
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

    body {
      font-family: "Inter", sans-serif;
    }

    /* Enhanced animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    /* Enhanced glassmorphism */
    .glassmorphism {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* Enhanced hover effects */
    .hover-lift {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Status pulse animation */
    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    .status-indicator {
      position: relative;
    }

    .status-indicator::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-100">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-black p-6 text-white">
      <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i class="fas fa-chart-line text-2xl"></i>
            <div>
              <h1 class="text-3xl font-bold">Dashboard</h1>
              <p class="text-gray-300 text-sm">Nostr pinning and media overview</p>
            </div>
          </div>
          <div class="flex gap-3">
            <button id="refresh"
              class="px-4 py-2 rounded-lg bg-white text-black font-semibold hover:bg-gray-200 transition-colors">
              <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
            <a href="/"
              class="px-4 py-2 rounded-lg border border-white text-white hover:bg-white hover:text-black transition-colors">
              <i class="fas fa-home mr-2"></i>Back to App
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <div class="max-w-6xl mx-auto">
        <!-- Alert Box -->
        <div id="alert" class="hidden mb-6 bg-white rounded-xl border border-red-500 p-4 shadow-lg animate-fade-in">
          <div class="flex items-center gap-3">
            <i class="fas fa-exclamation-circle text-red-600 text-2xl"></i>
            <div id="alertContent"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Left Column - Main Info -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Operator Card -->
            <div id="operatorCard" class="glassmorphism rounded-2xl shadow-xl p-6 hover-lift animate-fade-in">
              <div class="flex items-center gap-3 mb-4">
                <div class="status-indicator">
                  <i class="fas fa-user-shield text-2xl text-black"></i>
                </div>
                <div class="flex-1">
                  <p class="text-xs uppercase tracking-wider text-gray-500 font-medium">Operators</p>
                  <p class="text-lg font-semibold text-black" id="operatorCount">0</p>
                </div>
              </div>
              <div class="space-y-2 text-sm">
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <p class="text-gray-500 font-medium text-xs uppercase mb-2">NPUBs</p>
                  <div id="operatorsList" class="space-y-1">
                    <p class="text-black text-sm">-</p>
                  </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <p class="text-gray-500 font-medium text-xs uppercase">Relays</p>
                  <p class="text-black font-mono text-sm" id="relays">-</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <p class="text-gray-500 font-medium text-xs uppercase">Last Run</p>
                  <p class="text-black text-sm" id="lastRun">-</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Stats -->
          <div class="space-y-6">
            <!-- Pin Stats Card -->
            <div id="pinCard" class="glassmorphism rounded-2xl shadow-xl p-6 hover-lift animate-fade-in">
              <div class="flex items-center gap-3 mb-4">
                <i class="fas fa-thumbtack text-2xl text-black"></i>
                <div class="flex-1">
                  <p class="text-xs uppercase tracking-wider text-gray-500 font-medium">Pinned Files</p>
                  <p class="text-3xl font-bold text-black" id="pinsTotal">0</p>
                </div>
              </div>
              <div class="space-y-3">
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm font-medium">Self</span>
                    <span class="text-black font-bold" id="pinsSelf">0</span>
                  </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <p class="text-gray-500 font-medium text-xs uppercase mb-1">Repository Size</p>
                  <p class="text-black font-bold text-lg" id="repoSize">-</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pins History by NPUB -->
        <div class="mt-6" id="npubTablesContainer">
          <!-- Tables will be dynamically generated here for each NPUB -->
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-black p-4 text-center">
      <div class="flex items-center justify-center gap-4">
        <a href="https://github.com/besoeasy/Originless" target="_blank"
          class="flex items-center gap-2 text-white hover:text-gray-300 transition-colors duration-300">
          <i class="fab fa-github"></i>
          <span class="font-semibold">GitHub</span>
        </a>
        <span class="text-gray-400">•</span>
        <span class="text-gray-300 font-mono text-sm">Dashboard</span>
      </div>
    </footer>
  </div>

  <script>
    const operatorsList = document.getElementById("operatorsList");
    const operatorCount = document.getElementById("operatorCount");
    const relaysEl = document.getElementById("relays");
    const lastRunEl = document.getElementById("lastRun");
    const alertBox = document.getElementById("alert");
    const alertContent = document.getElementById("alertContent");
    const operatorCard = document.getElementById("operatorCard");

    async function load() {
      alertBox.classList.add("hidden");
      try {
        const res = await fetch("/nostr");
        const data = await res.json();

        if (!data.enabled) {
          alertBox.classList.remove("hidden");
          alertContent.innerHTML = `<div><div class="font-semibold text-red-800">Nostr Disabled</div><div class="text-red-600 text-sm mt-1">${data.reason || "NPUBs not configured"}</div></div>`;
          operatorCard.classList.add("hidden");
          return;
        }

        operatorCard.classList.remove("hidden");

        // Display operators as a list
        const operators = data.operators || [];
        operatorCount.textContent = operators.length;

        if (operators.length > 0) {
          operatorsList.innerHTML = operators.map(op =>
            `<a href="https://nosta.me/${encodeURIComponent(op)}" target="_blank"
                class="text-blue-600 hover:underline font-mono text-xs block break-all"
                title="${op}">
              ${op}
            </a>`
          ).join('');
        } else {
          operatorsList.innerHTML = '<p class="text-black text-sm">-</p>';
        }

        relaysEl.textContent = (data.relays || []).join(" · ") || "-";
        lastRunEl.textContent = data.lastRun?.at || "-";

        // Update pin stats from the same response
        const selfTotal = data.pins?.self?.total ?? 0;

        document.getElementById("pinsTotal").textContent = selfTotal;
        document.getElementById("pinsSelf").textContent = selfTotal;
        const size = data.repo?.size || 0;
        document.getElementById("repoSize").textContent = formatBytes(size);
      } catch (err) {
        alertBox.classList.remove("hidden");
        alertContent.innerHTML = `<div><div class="font-semibold text-red-800">Error</div><div class="text-red-600 text-sm mt-1">${err.message}</div></div>`;
        // Reset pin stats on error
        document.getElementById("pinsTotal").textContent = "-";
        document.getElementById("pinsSelf").textContent = "-";
        document.getElementById("repoSize").textContent = "Error";
      }
    }

    function formatBytes(bytes) {
      const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
      if (!bytes) return "0 Bytes";
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(2) + " " + sizes[i];
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp * 1000);
      return date.toLocaleString();
    }

    function truncate(str, len = 12) {
      if (!str) return '-';
      if (str.length <= len) return str;
      return str.substring(0, len) + '...';
    }

    // Pins table management
    let currentPage = 0;
    const limit = 50;

    // Generate a consistent color for an NPUB based on its hash
    function getNpubColor(npub) {
      let hash = 0;
      for (let i = 0; i < npub.length; i++) {
        hash = npub.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue}, 70%, 45%)`;
    }

    async function loadPins() {
      const container = document.getElementById("npubTablesContainer");

      try {
        container.innerHTML = '<div class="glassmorphism rounded-2xl shadow-xl p-6 animate-fade-in text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading pins...</div>';

        let url = `/api/pins?limit=${limit}&offset=${currentPage * limit}`;

        const res = await fetch(url);
        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load pins');
        }

        const npubData = data.byNpub || {};
        const npubs = Object.keys(npubData);

        if (npubs.length === 0) {
          container.innerHTML = '<div class="glassmorphism rounded-2xl shadow-xl p-6 animate-fade-in text-center text-gray-500">No pins found</div>';
          return;
        }

        // Create a separate table for each NPUB
        container.innerHTML = npubs.map(npub => {
          const npubInfo = npubData[npub];
          const pins = npubInfo.pins || [];
          const stats = npubInfo.stats || {};
          const npubColor = getNpubColor(npub);

          return `
            <div class="glassmorphism rounded-2xl shadow-xl p-6 animate-fade-in mb-6">
              <!-- NPUB Header -->
              <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold" 
                       style="background-color: ${npubColor}">
                    ${npub.slice(4, 6).toUpperCase()}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-black">
                      <a href="https://nosta.me/${encodeURIComponent(npub)}" target="_blank"
                         class="hover:underline" title="${npub}">
                        ${npub === 'unknown' ? 'Unknown Operator' : truncate(npub, 24)}
                      </a>
                    </h2>
                    <p class="text-gray-500 text-sm">Operator pinned content</p>
                  </div>
                </div>
              </div>

              <!-- Stats Row -->
              <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                  <p class="text-blue-600 text-xs font-semibold uppercase mb-1">Total</p>
                  <p class="text-blue-900 text-2xl font-bold">${stats.total || 0}</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                  <p class="text-green-600 text-xs font-semibold uppercase mb-1">Pinned</p>
                  <p class="text-green-900 text-2xl font-bold">${stats.pinned || 0}</p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                  <p class="text-yellow-600 text-xs font-semibold uppercase mb-1">Pending</p>
                  <p class="text-yellow-900 text-2xl font-bold">${stats.pending || 0}</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                  <p class="text-red-600 text-xs font-semibold uppercase mb-1">Failed</p>
                  <p class="text-red-900 text-2xl font-bold">${stats.failed || 0}</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                  <p class="text-purple-600 text-xs font-semibold uppercase mb-1">Total Size</p>
                  <p class="text-purple-900 text-lg font-bold">${formatBytes(stats.totalSize || 0)}</p>
                </div>
              </div>

              <!-- Table -->
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-gray-100 border-b-2 border-gray-300">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Event ID</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">CID</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Size</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Status</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Timestamp</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Author</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200">
                    ${pins.length === 0 ?
              '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No pins for this operator</td></tr>' :
              pins.map(pin => {
                const statusColor = {
                  'pinned': 'bg-green-100 text-green-800',
                  'pending': 'bg-yellow-100 text-yellow-800',
                  'failed': 'bg-red-100 text-red-800'
                }[pin.status] || 'bg-gray-100 text-gray-800';

                return `
                          <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3">
                              <a href="https://primal.net/e/${pin.eventId}" target="_blank" 
                                 class="text-blue-600 hover:underline font-mono text-xs"
                                 title="${pin.eventId}">
                                ${truncate(pin.eventId, 16)}
                              </a>
                            </td>
                            <td class="px-4 py-3">
                              <a href="https://ipfs.io/ipfs/${pin.cid}" target="_blank" 
                                 class="text-blue-600 hover:underline font-mono text-xs"
                                 title="${pin.cid}">
                                ${truncate(pin.cid, 16)}
                              </a>
                            </td>
                            <td class="px-4 py-3 font-mono text-xs">${formatBytes(pin.size)}</td>
                            <td class="px-4 py-3">
                              <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                                ${pin.status}
                              </span>
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-600">${formatTimestamp(pin.timestamp)}</td>
                            <td class="px-4 py-3">
                              <a href="https://nosta.me/${pin.author}" target="_blank" 
                                 class="text-blue-600 hover:underline font-mono text-xs"
                                 title="${pin.author}">
                                ${truncate(pin.author, 12)}
                              </a>
                            </td>
                          </tr>
                        `;
              }).join('')
            }
                  </tbody>
                </table>
              </div>

              <!-- Pagination for this NPUB -->
              ${npubInfo.pagination.total > limit ? `
                <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                  <div class="text-sm text-gray-600">
                    Showing ${Math.min(npubInfo.pagination.offset + 1, npubInfo.pagination.total)}-${Math.min(npubInfo.pagination.offset + limit, npubInfo.pagination.total)} of ${npubInfo.pagination.total}
                  </div>
                  <div class="flex gap-2">
                    <button class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === 0 ? 'disabled' : ''}
                            onclick="prevPage()">
                      <i class="fas fa-chevron-left mr-2"></i>Previous
                    </button>
                    <button class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${!npubInfo.pagination.hasMore ? 'disabled' : ''}
                            onclick="nextPage()">
                      Next<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Failed to load pins:', err);
        container.innerHTML = `<div class="glassmorphism rounded-2xl shadow-xl p-6 animate-fade-in text-center text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Error: ${err.message}</div>`;
      }
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        loadPins();
      }
    }

    function nextPage() {
      currentPage++;
      loadPins();
    }

    document.getElementById("refresh").addEventListener("click", () => {
      load();
      loadPins();
    });

    load();
    loadPins();
  </script>
</body>

</html>